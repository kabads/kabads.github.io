<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Setting Up MySQL Replication as a back-up solution</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.82.0" />
  <link href="" rel="alternate" type="application/rss+xml" title="Kabads. Musings, mutterings and murmerings." />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/hc.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
    
    </head>
    <body>
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
      <div id = "wrapper">


<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/"><p class="navbar-brand">Kabads. Musings, mutterings and murmerings.</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="" />
          <li class="sidebar-brand"><a href="/"><h1 class="brand">Kabads. Musings, mutterings and murmerings.</h1></a><h3></h3></li>
          <hr />
					
          <hr />
          <div id="social-wrapper">
           
           
           
           
         </div>
       </ul>
     </div>



     <div class="container">


  <div id="article">
   <div class="article-title">Setting Up MySQL Replication as a back-up solution</div>
   <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2018-08-27</small></p> <hr/>
   <div class="post">
     <p>MySQL replication is a good thing to have. It provides greater resilience and removes a single point of failure. By following these steps, you will create a replica of a master server, acting as a permanent backup in the case of a DR scenario.</p>
<h3 id="introduction">Introduction</h3>
<p>MySQL servers can be a single point of failure if you have not set up a good back-up infrastructure. It is difficult to get a good back-up infrastructure in place, without some time spent out of service. However, a MySQL replication server avoids this downtime.</p>
<p>One server will act as the master, and the other will act as slave. The slave will be paused and then backed up.</p>
<h3 id="benefits-of-running-a-replicated-mysql-server">Benefits of running a replicated MySQL server:</h3>
<ul>
<li>Remove single point of failure adding high availability</li>
<li>Improved performance if applications can use the read-only server (think data querying)</li>
</ul>
<p><img src="https://s3.eu-west-2.amazonaws.com/kabads.monkeez.org/images/mysql_replication.png" alt="Master/Slave Server diagram"></p>
<h3 id="conifgure-the-master-mysql-server">Conifgure the Master MySQL server</h3>
<p>The master is the live database that is serving your users. To back this up on it&rsquo;s own, you will have to stop transactions on the server and then carry out the backup. In a lot of high availability environments, this is not an option. However, you can prepare your master MySQL server to send those transactions to a different server.</p>
<p>In <code>/etc/my.conf</code> add the following lines:</p>
<pre><code>log-bin       = master-bin
log-bin-index = master-bin.index
server-id      = 1
</code></pre><p>The <code>log-bin</code> directive tells mysql to store a binary log. This binary log is what makes replication easy and quick. We also have a <code>log-index</code>. The binary log tells the other server the events that are happening on the master server.</p>
<p>You can watch the binary log file with the mysql prompt with <code>SHOW BINLOG EVENTS\G;</code>. However, to find out which binlog file is currently being written to you should enter <code>SHOW MASTER STATUS;</code> and then <code>SHOW BINLOG EVENTS IN 'master-bin.000002'\G;</code> (or whatever file was returned from the master status command.</p>
<p>If you added the replication config lines above after creating the server, as opposed to when you first set the server up, you will need to restart the mysql server:</p>
<pre><code>service mysql-server restart
</code></pre>
<p>Then you will need to login to the MySQL command prompt:</p>
<pre><code>mysql -u root
</code></pre>
<p>Next, it is good practise to create a user for replication that only has access rights for the IP range for the subnet where the slave server is.</p>
<pre><code>CREATE USER repl_user; 
GRANT REPLICATION SLAVE ON *.*
TO repl_user IDENTIFIED BY 'password';
</code></pre>
<p>This user will have access to retrieve the binary log from the master server.</p>
<h3 id="configuring-the-mysql-slave-server">Configuring the MySQL slave Server</h3>
<p>Again, we need a user that has certain privileges on the slave server.</p>
<pre><code>GRANT REPLICATION, SLAVE, RELOAD, CREATE USER, SUPER ON *.* TO user@'1.2.3.%' WITH GRANT OPTION;
</code></pre><p>Next, you will have to log in to the slave mysql server and issue the following command:</p>
<pre><code>CHANGE MASTER TO MASTER_HOST = '1.2.3.4', MASTER_PORT = 3306, MASTER_USER = 'repl_user', MASTER_PASSWORD = 'password';
START SLAVE;
</code></pre><p>Any changes for new databases on the master server will now be replicated on the slave server.</p>
<h3 id="enabling-replication-on-an-existing-database">Enabling replication on an existing database</h3>
<p>If you already have a database on the master server, that you also want to replicate, you will need to copy it over to the slave database.</p>
<p>If the database is relatively small (i.e. less than 50MB), then the <code>mysqldump</code> command will work. Shutdown the database first to ensure data integrity.</p>
<p><code>mysqldump -u root -p databasename &gt; file.sql</code></p>
<p>If the dataset is large, then it will be better to create an archive of the files and then transfer that over to the slave machine and restart the server there. Firstly, you should shutdown the mysql server.</p>
<p>Then, on the slave server, copy the files in the database directory (usually <code>/var/lib/mysql</code>). You can then tar that and then copy to the slave server and extract there. If there are large differences between the configuration files between the servers, then this might not work.</p>
<h3 id="carry-out-the-backup">Carry out the backup</h3>
<p>Now that we have a slave, we can take point in time back-ups by stopping the slave and pausing transactions (although transactions are still ongoing on the master server).</p>
<ol>
<li>
<p>Shut down the server <code>sudo service mysql-server stop</code></p>
</li>
<li>
<p>Copy the data files to a secure off-site location (in this case, Amazon S3) <code>sudo aws s3 sync --delete /var/lib/mysql s3://bucket-name/</code></p>
</li>
<li>
<p>Restart the server <code>sudo service mysql-service start</code></p>
</li>
</ol>

   </div>
 </div>


 <a href="https://twitter.com/share" class="twitter-share-button " data-size="small" data-count="none">Tweet</a>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

 <ul class="pager">
      &nbsp;<li class="previous"><a href="/post/2018-08-11-configure-autofs/"> Configure Autofs on Arch Linux</a></li>
      &nbsp;<li class="next"><a href="/post/2019-03-10-using-fujitsu-snapscan-s1300i-on-arch/"> Setting Up Fujitsu Snapscan S1300i on Arch Linux</a></li>
</ul>



    </ul>
    </div>
    <footer>

        <p class="text-muted credit">&copy; 2021. All rights reserved. </p>
    </footer>
 
    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script type="text/javascript" src="/js/hc.js"></script>
</body>

</html>

